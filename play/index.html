<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Upload Files</title>

    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(15, 22, 44, 0.82);
        --panel2: rgba(15, 22, 44, 0.65);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.7);
        --border: rgba(255, 255, 255, 0.12);
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
        --radius: 18px;
      }

      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        padding: 0;
        background: radial-gradient(1200px 800px at 20% 10%, #1b2a5a 0%, transparent 60%),
          radial-gradient(900px 700px at 90% 20%, #2a1a5a 0%, transparent 55%),
          radial-gradient(900px 900px at 50% 100%, #0a1b2b 0%, transparent 55%),
          var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
        overflow: hidden;
      }

      /* Canvas: fill the viewport crisply */
      #screen {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        display: block;
        image-rendering: pixelated; /* good for RCT2 style visuals */
        background: transparent;
      }

      /* Overlay centered panel */
      #overlay {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        padding: 24px;
        pointer-events: auto;
      }

      .panel {
        width: min(520px, 92vw);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 22px 20px 18px;
      }

      .title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 0 10px;
        font-size: 18px;
        letter-spacing: 0.2px;
      }

      .subtitle {
        margin: 0 0 14px;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.35;
      }

      .row {
        display: grid;
        gap: 10px;
      }

      .progress {
        display: grid;
        gap: 8px;
        margin: 14px 0 10px;
      }

      .progressbar {
        height: 10px;
        background: var(--panel2);
        border: 1px solid var(--border);
        border-radius: 999px;
        overflow: hidden;
      }

      .progressbar > div {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(100, 180, 255, 0.9), rgba(190, 120, 255, 0.9));
        border-radius: 999px;
        transition: width 120ms linear;
      }

      #overlay-text {
        font-variant-numeric: tabular-nums;
        color: var(--text);
        font-size: 14px;
        min-height: 20px;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-top: 10px;
      }

      input[type="file"],
      button#data-folder {
        width: 100%;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 12px 12px;
        font-size: 14px;
        outline: none;
        box-sizing: border-box;
      }

      button#data-folder {
        cursor: pointer;
        background: linear-gradient(180deg, rgba(120, 170, 255, 0.18), rgba(255, 255, 255, 0.06));
      }
      button#data-folder:hover {
        background: linear-gradient(180deg, rgba(120, 170, 255, 0.26), rgba(255, 255, 255, 0.07));
      }
      button#data-folder:active {
        transform: translateY(1px);
      }

      .hint {
        margin-top: 10px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.62);
        line-height: 1.35;
      }

      .error {
        color: rgba(255, 160, 160, 0.95);
      }

      /* Reduce motion if user prefers */
      @media (prefers-reduced-motion: reduce) {
        .progressbar > div {
          transition: none;
        }
      }
    </style>
  </head>

  <body>
    <canvas id="screen" width="1600" height="1200"></canvas>

    <div id="overlay">
      <div class="panel">
        <h1 class="title">OpenRCT2 Web</h1>
        <p class="subtitle">
          Select your <strong>RollerCoaster Tycoon 2</strong> install folder so the game can find
          <code>Data/ch.dat</code>.
        </p>

        <div class="progress" aria-live="polite">
          <div class="progressbar" aria-hidden="true"><div id="progress-fill"></div></div>
          <div id="overlay-text"></div>
        </div>

        <div class="row">
          <label for="data-folder">Select your RCT2 data path</label>
          <input id="data-folder" type="file" webkitdirectory="1" />
          <div class="hint">
            Tip: choose the folder that contains <strong>Data</strong> (and inside it,
            <strong>ch.dat</strong>).
          </div>
        </div>
      </div>
    </div>

    <script>
      var assets = {};

      // ---- Small UI helper: throttle overlay updates to avoid jank ----
      const overlayTextEl = () => document.getElementById("overlay-text");
      const progressFillEl = () => document.getElementById("progress-fill");

      let lastUiUpdate = 0;
      function setProgress(pct, text) {
        const now = performance.now();
        if (now - lastUiUpdate < 50 && pct < 100) return; // ~20fps UI updates max
        lastUiUpdate = now;
        if (typeof pct === "number") {
          progressFillEl().style.width = Math.max(0, Math.min(100, pct)) + "%";
        }
        if (text != null) overlayTextEl().textContent = text;
      }

      // ---- Ensure canvas scales to device and stays crisp ----
      const canvas = document.getElementById("screen");
      function resizeCanvasToDisplaySize() {
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        const rect = canvas.getBoundingClientRect();
        const w = Math.round(rect.width * dpr);
        const h = Math.round(rect.height * dpr);
        if (canvas.width !== w || canvas.height !== h) {
          canvas.width = w;
          canvas.height = h;
        }
      }
      window.addEventListener("resize", () => {
        // Avoid resize thrash
        requestAnimationFrame(resizeCanvasToDisplaySize);
      });
      requestAnimationFrame(resizeCanvasToDisplaySize);

      var Module = {
        canvas: canvas,
        arguments: [
          "--openrct2-data-path=persistent/rct2-data-path",
          "--user-data-path=persistent/user-data-path",
        ],
        preRun: () => {
          addRunDependency("syncfs");
          FS.init(() => null);
          FS.mkdirTree("/persistent");
          FS.mount(IDBFS, {}, "/persistent");
          FS.syncfs(true, (err) => {
            FS.mkdirTree("/persistent/user-data-path");
            FS.mkdirTree("/persistent/rct2-data-path");

            for (const assetKey of Object.keys(assets)) {
              var assetPath = assetKey;
              if (assetPath.startsWith(".")) assetPath = assetKey.substring(1);
              assetPath = "/persistent" + assetPath;

              const folder = assetPath.slice(0, assetPath.lastIndexOf("/"));
              try {
                FS.mkdirTree(folder);
              } catch (e) {}

              var stream = FS.open(assetPath, "w+");
              FS.write(stream, assets[assetKey], 0, assets[assetKey].byteLength, 0);
              FS.close(stream);

              delete assets[assetKey];
            }

            if (typeof localStorage != "undefined") {
              FS.syncfs(false, (err) => {
                if (!err) {
                  localStorage["rct2-data-version"] = 1;
                  localStorage["rct2-data-checked"] = 1;
                }
                console.log("FS sync'd! ...Bang!", err);
                removeRunDependency("syncfs");
              });
            } else {
              removeRunDependency("syncfs");
            }
          });
        },
        onRuntimeInitialized: function () {
          FS.ignorePermissions = true;

          window.onerror = (evt, src, line, error) => {
            if (typeof error === "number") {
              setTimeout(() => {
                try {
                  console.error(Module.getExceptionMessage(error));
                } catch (err) {
                  console.error(error, "(Failed to get error message D:)", err);
                }
              });
            } else {
              console.error(error);
            }
          };

          console.log("getExceptionMessage:", Module.getExceptionMessage);
          Module.websocket.url =
            (location.protocol == "http:" ? "ws:" : "wss:") +
            "//" +
            location.host +
            location.pathname +
            "websockify";
          Module.websocket.subprotocol = "binary";
        },
      };

      let assetsReceived = 0;
      let assetsTotal = 0;

      function launch() {
        Module.canvas.oncontextmenu = () => false;

        // Ensure final resize before starting
        resizeCanvasToDisplaySize();

        var script = document.createElement("script");
        script.src = "openrct2.js";
        document.body.appendChild(script);

        var prevQuery = document.querySelector;
        document.querySelector = function (selector) {
          if (selector == "#canvas") return window.top.document.getElementById("screen");
          else return prevQuery(selector);
        };
      }

      async function load(path) {
        return new Promise((res) => {
          var oReq = new XMLHttpRequest();
          oReq.open("GET", path, true);
          oReq.responseType = "arraybuffer";
          oReq.onload = () => {
            var arrayBuffer = oReq.response;
            if (arrayBuffer) {
              assets[path] = new Uint8Array(arrayBuffer);
              assetsReceived++;
              const pct = assetsTotal ? ((100 * assetsReceived) / assetsTotal) | 0 : 0;
              setProgress(pct, pct + "%");
            } else {
              console.error("load failed", path);
            }
            res();
          };
          oReq.send(null);
        });
      }

      async function ingestDirectory(parts, dirHandle) {
        for await (const [name, handle] of dirHandle.entries()) {
          if (handle.kind == "file") {
            const file = await handle.getFile();
            assets["/" + parts.join("/") + "/" + name] = new Uint8Array(await file.arrayBuffer());
          } else if (handle.kind == "directory") {
            await ingestDirectory(parts.concat([name]), handle);
          }
        }
      }

      function customDirectoryPicker() {
        const button = document.getElementById("data-folder");
        if (button.tagName == "BUTTON") {
          return new Promise((resolve) => {
            button.addEventListener(
              "click",
              () => {
                resolve();
              },
              { once: true }
            );
          }).then(() => showDirectoryPicker());
        } else {
          button.value = "";
          return new Promise((resolve) => {
            button.addEventListener(
              "change",
              (ev) => {
                resolve(ev.target.files);
              },
              { once: true }
            );
          });
        }
      }

      async function doAllLoads() {
        setProgress(0, "Preparing…");

        if (window.showDirectoryPicker) {
          document.getElementById("data-folder").remove();
          const ackButton = document.createElement("button");
          ackButton.id = "data-folder";
          ackButton.textContent = "Pick your RCT2 Data directory";
          document.querySelector(".row").insertBefore(ackButton, document.querySelector(".hint"));
        }

        let prom = customDirectoryPicker();

        if (localStorage["rct2-data-version"] != 1) {
          const loads = await fetch("output.json")
            .then((response) => response.json())
            .then((json) => {
              return Object.keys(json).flatMap((root) =>
                Object.keys(json[root]).map((idx) => () => load(root + "/" + json[root][idx]))
              );
            });

          assetsTotal = loads.length;
          setProgress(0, "Downloading assets…");

          // Same logic, but yield between big batches so UI stays responsive.
          while (loads.length) {
            await Promise.all(loads.splice(0, 1000).map((f) => f()));
            await new Promise((r) => requestAnimationFrame(r));
          }
        }

        const overlayText = overlayTextEl();

        if (localStorage["rct2-data-checked"] != 1) {
          while (1) {
            try {
              setProgress(100, "Waiting for folder selection…");

              const files = await prom;
              if (files instanceof FileSystemDirectoryHandle) {
                // validate
                await (await files.getDirectoryHandle("Data")).getFileHandle("ch.dat");
                await ingestDirectory(["rct2-data-path", "app"], files);
              } else {
                const filesArr = Array.from(files).map((file) => ({
                  file,
                  path: file.webkitRelativePath.slice(file.webkitRelativePath.indexOf("/") + 1),
                }));
                if (!filesArr.some((file) => file.path == "Data/ch.dat")) {
                  throw new Error("No Data/ch.dat file");
                }
                for (const file of filesArr) {
                  assets["/rct2-data-path/app/" + file.path] = new Uint8Array(
                    await file.file.arrayBuffer()
                  );
                }
              }
              break;
            } catch (err) {
              console.error(err);
              overlayText.classList.add("error");
              overlayText.textContent =
                "Sorry, that didn't look right. The game folder should contain a folder named 'Data' which contains 'ch.dat'.";
            }
            prom = customDirectoryPicker();
          }

          overlayText.classList.remove("error");
          overlayText.textContent = "Finalizing…";
          await load("./user-data-path/config.ini");
        }

        document.getElementById("overlay").style.display = "none";
        launch();
      }

      doAllLoads();

      function _Blit1to4($0) {
        $0 = $0 | 0;
        var $$0$us = 0,
          $$05472 = 0,
          $$05472$us = 0,
          $$06271 = 0,
          $$06271$us = 0,
          $$1 = 0,
          $$155$us = 0,
          $$163$us = 0,
          $$2 = 0,
          $$256 = 0,
          $$264 = 0,
          $$3 = 0,
          $$357 = 0,
          $$365 = 0,
          $$4 = 0,
          $$458 = 0,
          $$466 = 0,
          $$5 = 0,
          $$559 = 0,
          $$567 = 0,
          $$6 = 0,
          $$660 = 0,
          $$668 = 0,
          $$7 = 0,
          $$761 = 0,
          $$769 = 0,
          $$8 = 0,
          $$870 = 0,
          $12 = 0,
          $128 = 0,
          $14 = 0,
          $2 = 0,
          $4 = 0,
          $5 = 0,
          $7 = 0,
          $73 = 0,
          $78 = 0,
          $83 = 0,
          $9 = 0,
          label = 0;
        $4 = HEAP32[($0 + 28) >> 2] | 0;
        if (!$4) return;
        $5 = HEAP32[$0 >> 2] | 0;
        $7 = HEAP32[($0 + 16) >> 2] | 0;
        $9 = HEAP32[($0 + 20) >> 2] | 0;
        $2 = HEAP32[($0 + 24) >> 2] | 0;
        $12 = ((HEAP32[($0 + 36) >> 2] | 0) / 4) | 0;
        $14 = HEAP32[($0 + 48) >> 2] | 0;
        if (!($2 & 7)) {
          $$05472$us = $5;
          $$06271$us = $9;
          $73 = ($4 + -1) | 0;
          while (1) {
            $$0$us = ((($2 + 7) | 0) / 8) | 0;
            $$155$us = $$05472$us;
            $$163$us = $$06271$us;
            while (1) {
              HEAP32[$$163$us >> 2] =
                HEAP32[($14 + ((HEAPU8[$$155$us >> 0] | 0) << 2)) >> 2];
              HEAP32[($$163$us + 4) >> 2] =
                HEAP32[($14 + ((HEAPU8[($$155$us + 1) >> 0] | 0) << 2)) >> 2];
              HEAP32[($$163$us + 8) >> 2] =
                HEAP32[($14 + ((HEAPU8[($$155$us + 2) >> 0] | 0) << 2)) >> 2];
              HEAP32[($$163$us + 12) >> 2] =
                HEAP32[($14 + ((HEAPU8[($$155$us + 3) >> 0] | 0) << 2)) >> 2];
              HEAP32[($$163$us + 16) >> 2] =
                HEAP32[($14 + ((HEAPU8[($$155$us + 4) >> 0] | 0) << 2)) >> 2];
              HEAP32[($$163$us + 20) >> 2] =
                HEAP32[($14 + ((HEAPU8[($$155$us + 5) >> 0] | 0) << 2)) >> 2];
              HEAP32[($$163$us + 24) >> 2] =
                HEAP32[($14 + ((HEAPU8[($$155$us + 6) >> 0] | 0) << 2)) >> 2];
              HEAP32[($$163$us + 28) >> 2] =
                HEAP32[($14 + ((HEAPU8[($$155$us + 7) >> 0] | 0) << 2)) >> 2];
              $$155$us = ($$155$us + 8) | 0;
              $$163$us = ($$163$us + 32) | 0;
              if (($$0$us | 0) <= 1) break;
              $$0$us = ($$0$us + -1) | 0;
            }
            if (!$73) break;
            $$05472$us = ($$155$us + $7) | 0;
            $$06271$us = ($$163$us + ($12 << 2)) | 0;
            $73 = ($73 + -1) | 0;
          }
          return;
        }
        $$05472 = $5;
        $$06271 = $9;
        $128 = ($4 + -1) | 0;
        L11: while (1) {
          switch ($2 & 7) {
            case 1: {
              $$7 = ((($2 + 7) | 0) / 8) | 0;
              $$8 = $$05472;
              $$870 = $$06271;
              label = 14;
              break;
            }
            case 7: {
              $$1 = ((($2 + 7) | 0) / 8) | 0;
              $$256 = $$05472;
              $$264 = $$06271;
              label = 8;
              break;
            }
            case 6: {
              $$2 = ((($2 + 7) | 0) / 8) | 0;
              $$357 = $$05472;
              $$365 = $$06271;
              label = 9;
              break;
            }
            case 5: {
              $$3 = ((($2 + 7) | 0) / 8) | 0;
              $$458 = $$05472;
              $$466 = $$06271;
              label = 10;
              break;
            }
            case 4: {
              $$4 = ((($2 + 7) | 0) / 8) | 0;
              $$559 = $$05472;
              $$567 = $$06271;
              label = 11;
              break;
            }
            case 3: {
              $$5 = ((($2 + 7) | 0) / 8) | 0;
              $$660 = $$05472;
              $$668 = $$06271;
              label = 12;
              break;
            }
            case 2: {
              $$6 = ((($2 + 7) | 0) / 8) | 0;
              $$761 = $$05472;
              $$769 = $$06271;
              label = 13;
              break;
            }
            default: {
              label = 15;
              break L11;
            }
          }
          while (1) {
            if ((label | 0) == 8) {
              HEAP32[$$264 >> 2] =
                HEAP32[($14 + ((HEAPU8[$$256 >> 0] | 0) << 2)) >> 2];
              $$2 = $$1;
              $$357 = ($$256 + 1) | 0;
              $$365 = ($$264 + 4) | 0;
              label = 9;
            }
            if ((label | 0) == 9) {
              HEAP32[$$365 >> 2] =
                HEAP32[($14 + ((HEAPU8[$$357 >> 0] | 0) << 2)) >> 2];
              $$3 = $$2;
              $$458 = ($$357 + 1) | 0;
              $$466 = ($$365 + 4) | 0;
              label = 10;
            }
            if ((label | 0) == 10) {
              HEAP32[$$466 >> 2] =
                HEAP32[($14 + ((HEAPU8[$$458 >> 0] | 0) << 2)) >> 2];
              $$4 = $$3;
              $$559 = ($$458 + 1) | 0;
              $$567 = ($$466 + 4) | 0;
              label = 11;
            }
            if ((label | 0) == 11) {
              HEAP32[$$567 >> 2] =
                HEAP32[($14 + ((HEAPU8[$$559 >> 0] | 0) << 2)) >> 2];
              $$5 = $$4;
              $$660 = ($$559 + 1) | 0;
              $$668 = ($$567 + 4) | 0;
              label = 12;
            }
            if ((label | 0) == 12) {
              HEAP32[$$668 >> 2] =
                HEAP32[($14 + ((HEAPU8[$$660 >> 0] | 0) << 2)) >> 2];
              $$6 = $$5;
              $$761 = ($$660 + 1) | 0;
              $$769 = ($$668 + 4) | 0;
              label = 13;
            }
            if ((label | 0) == 13) {
              HEAP32[$$769 >> 2] =
                HEAP32[($14 + ((HEAPU8[$$761 >> 0] | 0) << 2)) >> 2];
              $$7 = $$6;
              $$8 = ($$761 + 1) | 0;
              $$870 = ($$769 + 4) | 0;
              label = 14;
            }
            if ((label | 0) == 14) {
              label = 0;
              $78 = ($$8 + 1) | 0;
              $83 = ($$870 + 4) | 0;
              HEAP32[$$870 >> 2] =
                HEAP32[($14 + ((HEAPU8[$$8 >> 0] | 0) << 2)) >> 2];
              if (($$7 | 0) <= 1) break;
              HEAP32[$83 >> 2] =
                HEAP32[($14 + ((HEAPU8[$78 >> 0] | 0) << 2)) >> 2];
              $$1 = ($$7 + -1) | 0;
              $$256 = ($$8 + 2) | 0;
              $$264 = ($$870 + 8) | 0;
              label = 8;
            }
          }
          if (!$128) break;
          $$05472 = ($78 + $7) | 0;
          $$06271 = ($83 + ($12 << 2)) | 0;
          $128 = ($128 + -1) | 0;
        }
      }
    </script>
  </body>
</html>
